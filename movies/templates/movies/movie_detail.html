{% extends 'movies/base.html' %}

{% block title_block %}{{ movie.title }}{% endblock %}

{% block body_block %}
<div style="display: flex; gap: 30px; margin-top: 20px; flex-wrap: wrap;">

    <!-- Movie Poster -->
    <div>
        {% if movie.poster %}
            <img src="{{ movie.poster.url }}" alt="{{ movie.title }} poster" width="300">
        {% else %}
            <div style="width:300px; height:450px; background:#ccc; display:flex; align-items:center; justify-content:center;">
                No Image
            </div>
        {% endif %}
    </div>

    <!-- Movie Info -->
    <div style="flex: 1;">
        <h1>{{ movie.title }}</h1>
        <p><strong>Genre:</strong> {{ movie.genre }}</p>
        <p><strong>Release Date:</strong> {{ movie.release_date }}</p>
        <p>{{ movie.description }}</p>
        <a href="{% url 'movies:movie_list' %}" class="btn">Back to Movies</a>

        <!-- Favorites Button -->
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'movies:toggle_favorite' movie.id %}?next={% url 'movies:movie_detail' movie.id %}" style="margin-top:15px;">
                {% csrf_token %}
                <button type="submit" style="padding:8px 15px;">
                    {% if is_favorite %}
                        Remove from Favorites
                    {% else %}
                        Add to Favorites
                    {% endif %}
                </button>
            </form>
        {% endif %}
    </div>
</div>

<hr>

<!-- Reviews Section -->
<h2>Community Reviews</h2>
{% if reviews %}
    <div class="reviews" style="margin-top: 10px;">
        {% for review in reviews %}
            <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px;">
                <strong>{{ review.user.username }}</strong>
                <span>
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                    {% endfor %}
                </span>
                <br>
                {{ review.text }}
                <br>
                <small>{{ review.created_at }}</small>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p>No reviews yet.</p>
{% endif %}


<!-- Review Form -->
{% if user.is_authenticated %}
    <h3 style="margin-top:20px;">
        {% if existing_review %}Edit Your Review{% else %}Leave a Review{% endif %}
    </h3>
    <form method="post" action="{% url 'movies:movie_detail' movie.id %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">
            {% if existing_review %}Update{% else %}Submit{% endif %}
        </button>
    </form>

    {% if existing_review %}
        <form method="post" action="{% url 'movies:delete_review' movie.id %}" style="margin-top:10px;">
            {% csrf_token %}
            <button type="submit">Delete My Review</button>
        </form>
    {% endif %}
{% endif %}
{% endblock %}
